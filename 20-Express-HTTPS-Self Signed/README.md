# Express Https Test

Example of TLS using a tls-server and tls-client using a self signed certificate.

__NOTE__: For self-signed certificates, the certificate is its own CA. See example 21, where we will use a not self signed certificate 

### 1. Build our private key

First, we need to generate the private key

```shell
$ openssl genrsa -out private-key.pem 1024

Generating RSA private key, 1024 bit long modulus (2 primes)
...................................+++++
............+++++
e is 65537 (0x010001)
```

this generates the next file: __private-key.pem__ using RSA with 1024 bit long modulus (2 primes).

Basically, it's a set of random noise that's used to encrypt information.

## 2. Generate the CSR (Certificate signing request)

In public key infrastructure (PKI) systems, a certificate signing request (also CSR or certification request) is a message sent from an applicant to a certificate authority in order to apply for a digital identity certificate. It usually contains the public key for which the certificate should be issued, identifying information (such as a domain name) and integrity protection (e.g., a digital signature). The most common format for CSRs is the PKCS #10 specification; another is the Signed Public Key and Challenge SPKAC format generated by some web browsers.

Once we have our private key, we can create a CSR (certificate signing request), which is our request to have the private key signed by a fancy authority. That is why you have to input information related to your company. This information will be seen by the signing authority, and used to verify you. In our case, it doesnâ€™t matter what you type, since in the next step we're going to sign our certificate ourselves.

```shell
$ openssl req -new -key private-key.pem -out csr.pem

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:
State or Province Name (full name) [Some-State]:
Locality Name (eg, city) []:
Organization Name (eg, company) [Internet Widgits Pty Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:server-tls
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```

IMPORTANT: Note that in Common Name section, we put __server-tls__ (running in docker using server-tls as service name) or __localhost__ (running with npm in our local environment) as server FQDN 

this will create the private-key.pem

## 3. Create the public key (Sign the request)

Now that we have our paper work filled out, it's time to pretend that we're a cool signing authority.
We will need the __csr.pem__ and __private-key.pem__ previously generated. In this process, we will create our public key
and sign the csr.pem with our private key generated previously.

```shell
$ openssl x509 -req -in csr.pem -signkey private-key.pem -out public-cert.pem

Signature ok
subject=C = AU, ST = Some-State, O = Internet Widgits Pty Ltd
Getting Private key
```

This will create the server certificate (signed public key) in the file: public-cert.pem

## 4. Our application

Our application have two containers:

- server-tls
- client-tls

The server-tls needs to contain the private-key and public-key mounted and the client only needs the public-key.

## 5 .Executing all locally

### 5.1 Run the server

go to server folder and execute:

```shell
$ source ./init.sh
$ npm run start

--> App (IN): --> params IN:
port: 8443, 
key: -----BEGIN RSA PRIVATE KEY-----
MIICXQIBAAKBgQCz8dfKq67SC44i7iNoU7oXkMSGEMES1/iunc26ROMoQD4JXzkG
Sx5pSSUZQ1KcELU5Kak4vNNSWzLsG3jsfMNXO2ONGB3kaioVX4iQwzP6vNxrVzfd
eTqAuDnh7GZAQRmbHnoHRQcM6eP9YmcuWXbSvCmMSUIZ434lCTTKrk03KwIDAQAB
AoGASzRiGaQTFloZ92NLjQihF8Q7PkS2TKfSmTf+iUDNJz9iLgyMCqNOfHZDeQF3
/x3Ef7V3sezI7PyMlb0Nlti10oW7F6mdPhCDnsC9EuSOYKHSh9B5Kn+Ad/iR2xTe
cVq/On3XO4V0PjRnKGfp1Gn0xeembddx2Qokq9aAbjLQOEECQQDglDkB4n4cc+Hp
dzzmUVqnuKscEMuf4cfvH5FJO9RxlWv6B+dYe++dt+C5TO8F6Wh5yxdGUIqxcWO9
2FsC3IGbAkEAzR7yilgdcNHt9RtLXGpYACyKPIbX5QVICeTpmFQHkWAh72XUqOVU
b4ubUGIxiHE+//MlRL7lnPUgmUocTmIBsQJAGpMPh9yQRbektOaqKyrXSl98x+5o
2ftymCYpH/xXcDVZOJX01zCbMxOOIP8sjYuIFFlm4KgpMUQUpGNUqasEHwJBAIdI
DOBvIuOgoNcR7E8EGAvtVDJ9IHB8XjmgTuvXJ7Kae2cfevT1Yw26PnHygQai4dD+
tKq1WEx/YsOWnDqZ6tECQQDHgDVGjAf+2sMPAhxKvlmHmZNZasxwiKQ7Pj5v1e4z
jisaWQmVGEiU+bEPsIcSdruFay6wVm+PvGOgItzloKMJ
-----END RSA PRIVATE KEY-----
, 
cert: -----BEGIN CERTIFICATE-----
MIICNjCCAZ8CFENjD0X/NuYC5Z7PzLIUrcyHaf8tMA0GCSqGSIb3DQEBCwUAMFox
CzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRl
cm5ldCBXaWRnaXRzIFB0eSBMdGQxEzARBgNVBAMMCnNlcnZlci10bHMwHhcNMjAw
NTI4MTY1ODQ4WhcNMjAwNjI3MTY1ODQ4WjBaMQswCQYDVQQGEwJBVTETMBEGA1UE
CAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRk
MRMwEQYDVQQDDApzZXJ2ZXItdGxzMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKB
gQCz8dfKq67SC44i7iNoU7oXkMSGEMES1/iunc26ROMoQD4JXzkGSx5pSSUZQ1Kc
ELU5Kak4vNNSWzLsG3jsfMNXO2ONGB3kaioVX4iQwzP6vNxrVzfdeTqAuDnh7GZA
QRmbHnoHRQcM6eP9YmcuWXbSvCmMSUIZ434lCTTKrk03KwIDAQABMA0GCSqGSIb3
DQEBCwUAA4GBAD0VjXSOGpPe7oXwwPVhtehmtykW1QLBC6kIt3rFXiCAVWnuSQcu
HEjmDpUxBoGfDVlYag8iMG2CKcPCRoc2v2ku6S4MDSx/88wrgdByAzWmHfbWoIzE
ynF+tGL7DyTPj6yLq6sWnJCHQ4p0G55YtWCb0//sAEw8JBT+VtWEeqEK
-----END CERTIFICATE-----



--> NodeJS Express listening at port: 8443...try <<hostname>>/hellotls and enjoy!
entering in hellotls...
```

### 5.2 Run the client

go to client folder and execute:

```shell
$ source ./init.sh
$ npm run start

App (IN) --> Init

App (MID) --> endpoint: https://server-tls:8443/hellotls
App (MID) --> result connection: {"size":0,"timeout":0}
App (MID) --> jsonresponse: {"message":"Hello world express with https!"}

App (OUT) --> End
```

And viewing the log in the server, you have obtained:

```shell

result: {"message":"Hello world express with https!"}
```

## 6 .Executing all in docker

### 6.1 Run the server

Go to root folder and execute:

```shell
$ docker-compose up -d server-tls
```

### 6.2 Run the client

Go to root folder and execute:

```shell
$ docker-compoes up client-tls
```
