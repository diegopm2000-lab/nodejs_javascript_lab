# Express Https Test

Example of TLS using a tls-server and tls-client, with a NOT self signed certificate and in this case, the server will request to the client a certificate.

We will use a CA, and using this CA, we will create the certificates for the server and the clients.

Finally we will add a CRL (Certificate Revocation List) for the second client

## 1. Download the CA configuration file

```shell
$ wget https://raw.githubusercontent.com/anders94/https-authorized-clients/master/keys/ca.cnf
```

this will download the __ca.cnf__, file that we will use as CA configuration file

## 2. Create the new CA using this .cnf configuration file

```shell
$ openssl req -new -x509 -days 9999 -config ca.cnf -keyout ca-key.pem -out ca-crt.pem

Generating a RSA private key
..........++++
.......................................................................................................++++
writing new private key to 'ca-key.pem'
-----
```

this will generate our __ca-key.pem__ (Private Key) file and __ca-crt.pem__ (Certificate) file of the CA.

## 3. Create the certificate of the server

Using the ca-key.pem and ca-crt.pem, we need to create the server certificate.

```shell
$ openssl genrsa -out server-key.pem 4096

```

This will generate our __server-key.pem__ file as server certificate

## 4. Generate the Certificate Signing Request (CSR)

In public key infrastructure (PKI) systems, a certificate signing request (also CSR or certification request) is a message sent from an applicant to a certificate authority in order to apply for a digital identity certificate. It usually contains the public key for which the certificate should be issued, identifying information (such as a domain name) and integrity protection (e.g., a digital signature). The most common format for CSRs is the PKCS #10 specification; another is the Signed Public Key and Challenge SPKAC format generated by some web browsers.

NOTE: This is equivalent to the Step 2 in the previous example __20-Express-HTTPS-Self Signed__

```shell
$ wget https://raw.githubusercontent.com/anders94/https-authorized-clients/master/keys/server.cnf
```

We will obtain the file __server.cnf__ as configuration file to generate the CSR

Then, generate the csr:

```shell
$ openssl req -new -config server.cnf -key server-key.pem -out server-csr.pem
```

this will create the __server-csr.pem__ file

IMPORTANT: Note that in Common Name (CN) section, we need to change the default value to __server-tls__ (running in docker using server-tls as service name) or leave the default value to __localhost__ (running with npm in our local environment) as server FQDN 

## 5. Create the public key (sign the request)

```shell
openssl x509 -req -extfile server.cnf -days 999 -passin "pass:password" -in server-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial -out server-crt.pem
```

Creating the __server-crt.pem__ file as server certificate (public key signed)

## 6. Generate the client certificate

### 6.1 Generate two private keys for the clients

```shell
$ openssl genrsa -out client1-key.pem 4096
```

this will generate the __client1-key.pem__ (private key of client 1)

```shell
$ openssl genrsa -out client2-key.pem 4096
```

this will generate the __client1-key.pem__ (private key of client 2)

### 6.2 Get two configurations pregenerated

In this example, the server will request to the client a valid certificate.

```shell
$ wget https://raw.githubusercontent.com/anders94/https-authorized-clients/master/keys/client1.cnf
```

this will obtain the __client1.cnf__

```
$ wget https://raw.githubusercontent.com/anders94/https-authorized-clients/master/keys/client2.cnf
```

this will obtain the __client1.cnf__

### 6.3 Create a pair of certificate signing requests

```shell
$ openssl req -new -config client1.cnf -key client1-key.pem -out client1-csr.pem
```

this will generate the __client1-csr.pem__

```shell
$ openssl req -new -config client2.cnf -key client2-key.pem -out client2-csr.pem
```

this will generate the __client2-csr.pem__

### 6.4 Sign our client certs

```shell
openssl x509 -req -extfile client1.cnf -days 999 -passin "pass:password" -in client1-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial -out client1-crt.pem
```

this will generate the __client1-crt.pem__

```shell
openssl x509 -req -extfile client2.cnf -days 999 -passin "pass:password" -in client2-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial -out client2-crt.pem
```

this will generate the __client2-crt.pem__

### 6.5 Verify our signed certificates

```shell
openssl verify -CAfile ca-crt.pem client1-crt.pem

client1-crt.pem: OK
```
```shell
openssl verify -CAfile ca-crt.pem client2-crt.pem

client2-crt.pem: OK
```

## 7. Add the CRL (Certificate Revocation List)

Go to certs/client folder and create the first time a new empty database

```shell
$ touch ca-database.txt
```

Revoke the client 2 certificate

```shell
$ openssl ca -revoke client2-crt.pem -keyfile ca-key.pem -config ca.cnf -cert ca-crt.pem -passin 'pass:password'

Using configuration from ca.cnf
Can't open ca-database.txt.attr for reading, No such file or directory
140371872649664:error:02001002:system library:fopen:No such file or directory:../crypto/bio/bss_file.c:72:fopen('ca-database.txt.attr','r')
140371872649664:error:2006D080:BIO routines:BIO_new_file:no such file:../crypto/bio/bss_file.c:79:
Adding Entry with serial number 43C45A8392741DA5602AA702DE6D03A9ABEC098E to DB for /C=US/ST=MA/L=Boston/O=Example Co/OU=techops/CN=client2/emailAddress=certs@example.com
Revoking Certificate 43C45A8392741DA5602AA702DE6D03A9ABEC098E.
Data Base Updated
```

Update the CRL

```shell
$ openssl ca -keyfile ca-key.pem -cert ca-crt.pem -config ca.cnf -gencrl -out ca-crl.pem -passin 'pass:password'

Using configuration from ca.cnf
```

Finally, we need to add the crl file __ca-crl.pem__ into the server config (look at index.js server file)

## 8. Our application

Our application have two containers:

- server-tls
- client-tls

The server-tls needs to contain the private-key and public-key mounted and the client only needs the public-key.

## 9 .Executing all locally

### 9.1 Run the server

go to server folder and execute:

```shell
$ source ./init.sh
$ npm run start

--> App (IN): --> params IN:
port: 8443, 
key: -----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----, 
cert: -----BEGIN CERTIFICATE-----
MIIFlzCCA3+gAwIBAgIUQAa7oZL6hp4ZTnurQ4EpU7h42pEwDQYJKoZIhvcNAQEL
BQAwgYExCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJNQTEPMA0GA1UEBwwGQm9zdG9u
MRMwEQYDVQQKDApFeGFtcGxlIENvMRAwDgYDVQQLDAd0ZWNob3BzMQswCQYDVQQD
DAJjYTEgMB4GCSqGSIb3DQEJARYRY2VydHNAZXhhbXBsZS5jb20wHhcNMjAwNjAx
MTczMzA0WhcNMjMwMjI1MTczMzA0WjCBiDELMAkGA1UEBhMCVVMxCzAJBgNVBAgM
Ak1BMQ8wDQYDVQQHDAZCb3N0b24xEzARBgNVBAoMCkV4YW1wbGUgQ28xEDAOBgNV
BAsMB3RlY2hvcHMxEjAQBgNVBAMMCWxvY2FsaG9zdDEgMB4GCSqGSIb3DQEJARYR
Y2VydHNAZXhhbXBsZS5jb20wggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoIC
AQCxWw+h0+Ab4dsrKjJRXpeTFPTP2nCn37F3W5ZCoYu3oJIzhXWLvw782QZsRqJN
/IT5dgKQr+bY/aXceJfJhwCjgY18zl7X64dR5pio4u0gx0ENOaBd/Yiv3RPKyGn1
s6d++b20maSu7LSY8CqIaWJHDhV2GOVAHTZGvvMNuPbr3rurZx5skQdB/rPD5QTv
EW0vtVmO+rI8c6xZodcAp2KRKf+fTRqHPlSbkohGXLlVLrS+k+fAIB2d+7VffaVJ
9iJ8C+PrmiIFEGJ6tKFy1mSL8Vyynkc7p1odZ1UhYxPG/PHsaevInuFwZN0MLVW8
kxfTV/CfNCoUId11zuV3jwycSKppjrWh3UmTQZ3L4Lyv7jipikx/EXqwRJjcV20L
Z4V5bWZKzhdovyXjpdoI7PmY06ZZV5sJKM+jouH6nhwhS61NG0P88FFwudfZnTXt
ghBYcwvEO3LwaoyLDN6FZ58eO0IBupO+QKvQTQ+xihve+jumvxZMoMUil1vGeiuc
m61Y/r8AoPy1HAllSBCma6eVfM3A/mBpY2a1kYQnFyibsujzN29T5lpnMAV6uI/4
x7lpa/SdItTwmdwpj8K3z7mNmCXi2EN/cJ4cI7lSLVeic73Hp6/2My7z870yFtk7
mfhU+xEp8sEmnpdOGEsbsX8KnMSCN/T9Q6p5Wm88sirnNQIDAQABMA0GCSqGSIb3
DQEBCwUAA4ICAQACwKjKmxCJu8/2JHcfafF3V56I06YDCEtTdPvI/ntMBe3bjzdW
lCv67vKFStNwxgHS5HCBdB0zsS+bSNo75JfUSbhR7lvveG+8BsMiWVZJqxzfhByX
U+gkKsgvwA8InjepFTj3erN62OJmA5wAyc6Mzwy8m3K3Y4B82C9JP8p4nXdeOdj7
iBgTvVqBLQGbo2ZCzuO9gjGw1+uwyzHf6Os1wkvUG+nNjwx2blKV14Las1hfHMd4
UAx3jQpzok8MbEoI/BlW5rth5i8a0Bxv/Py8AzLBhd44rxJLPSdVSrb71FdLBdj6
yzVfjz5RwY+DY2wUF3wLSsYsjDdMvmkXWCUokvpRPbfPzFe6rvXdS5e1gX91cKy/
Ck7RdBNx6u0XNh7wzUfT/faT4AKUW1eEaCIFsx77C/UeNLA17nL4A9gmpe1vG+lf
7OImydDWMsN7lov1h6Jm+qPdmB7TtpQs8F5xGG90MD6sh8aWRvHmbx2HZiXNYvmV
AzFKac1eZmcd2G6J4p+MMS+f6DmKg/xfNy+iF95UPvS8AFDsoZcX9U6asv1bgYLG
J27jtCNkmZ6yTkC302CJa6c3Brw0sJxweZXDqpm1dzQe0Mxz4599vw4ZOb2ZVNWb
hmBz+JhyK6wbrJWGhYT5xJlHr0GQOM4XKMz2rm3ceToHgFQZOTwq3+XspA==
-----END CERTIFICATE-----, 
ca: -----BEGIN CERTIFICATE-----
MIIFizCCA3MCFG6HPPY/m+9AXHwr9jJ67l5vF2zdMA0GCSqGSIb3DQEBCwUAMIGB
MQswCQYDVQQGEwJVUzELMAkGA1UECAwCTUExDzANBgNVBAcMBkJvc3RvbjETMBEG
A1UECgwKRXhhbXBsZSBDbzEQMA4GA1UECwwHdGVjaG9wczELMAkGA1UEAwwCY2Ex
IDAeBgkqhkiG9w0BCQEWEWNlcnRzQGV4YW1wbGUuY29tMB4XDTIwMDYwMTE3MTg0
MFoXDTQ3MTAxNzE3MTg0MFowgYExCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJNQTEP
MA0GA1UEBwwGQm9zdG9uMRMwEQYDVQQKDApFeGFtcGxlIENvMRAwDgYDVQQLDAd0
ZWNob3BzMQswCQYDVQQDDAJjYTEgMB4GCSqGSIb3DQEJARYRY2VydHNAZXhhbXBs
ZS5jb20wggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQDDMC6D5WfeCBnO
j/fy08LG7hag+zBK8nJUyjypDFsicd3evHJJqyoqVi76dHqB3H+jo9bxjmEeRtAP
G+EB7dS1YGX5BUzlfQUMZUG45cXFaACo38DRcPvHuqcIAEsom5X+AxJcnZaDIDv4
yTicFNPucGjv9PJYDIG4X1CCGgRUw7wnMw1bKn1ddr/Sq5G3N60GFqv6waXccOCN
i7XbwK8jdw0WL9TipiGRSZJBFWt1wMSEm6KciOn8VhqMOI4i/mMs84rvf9XW2lie
6kUqMjmh8AUXL3RYeXqTLpz7pwSS0ecEZoZ0iPBNVn4HYa4vDRmQihFimwXnfrK9
aKdLqXS2oV9h8D+6DI46zR6sI+zHwl3WfTVtXMgAsu74dnLUVOeKL4klHfxXBM+k
hR/oy9RBjTpLZPCu/J2OsP66SwhjR+7X34wrqIUw3L+uPO55DHLZ43sLvEhtggHo
BSPwu8kxyEn9Rr1rUs5A0HzrbIN2YUsmrqI+BLRRWjf26KGIgedOtJqQ1hAXwZlj
ZnxgVIStfVg5QrzGTmSxviJNOsbDETLUUpK61SH1is5peAqyyzvT1pKe6yNriU4t
mRYw56ZT8l6+feFbrwwFw7Eeo/nmctwrGo9cfx/7igtp2ksOGgN2fQHRD/L/itxI
Y3dPGjfC/5kiuT5P4ilkq1w+BnX6nQIDAQABMA0GCSqGSIb3DQEBCwUAA4ICAQAX
MNHb06jwW7WyvsFvH1kiL91UacKijxlThYs1otpj/NtU3U3hvq1La6UZAKIeO7Am
kKxVTWmYiJR1o3mqjZTLzuBSmHPPrbykVflC4pySm871DkloZGsHQ1frUD5XKjka
IRop9+MevY5i3RiYxwVgTtSSDZ0rLsxzM7mTzmGe0XU0RgPB2jxnzTFYaN2M9HwY
xGIjAyq7aizdYunOTBpNrBrmXpRl6g8fE1G5mIiEw5OuCAD7hxz8tLpDlYU2QtJw
5Ai6MwpxWOgv+v6rJq6mrvpxO1tOwCNO9FM9fPIk+Uj5la/u+oLNvMbeo32LwVxF
f7B4oEwpEO4RT+ugRDyzfSc+8jhdt8lMkDmAaHllnxFoHCTkQWC7GAhIm1ElmPUu
hsnTjSMnbV/GYrwYpBF6bKH3fJtmBVmAzKeR9jZPt6kn/MU7LnG+jc5LNdnqtCDm
HMTD4HfE2lzgfrFfobRFCXrCNExF64DPZzljYAizztRouEvKQdLqcjwx1T/4Vp6n
3fGCnmEutIcTgi7LLpSeG6PrK+AZoRBfiI9mzatfu++gEJOEA8sVPWQ6sqaN/VB0
tUiUw01SCsaaeBvz+647LtvjZBYEe7kGZTuGXuDJW/CYtT34keCWJ4i3tT5uxlSp
EdAfGQNKTF8hneVF8S5x7MYlAPchzmWrWxUYu1Mrkg==
-----END CERTIFICATE-----


--> NodeJS Express listening at port: 8443...try <<hostname>>/hellotls and enjoy!
entering in hellotls...
```

### 9.2 Run the client

go to client folder and execute:

__Client 1__

```shell
$ source ./init_client1.sh
$ npm run start

App (IN) --> Init

App (MID) --> endpoint: https://server-tls:8443/hellotls
App (MID) --> result connection: {"size":0,"timeout":0}
App (MID) --> jsonresponse: {"message":"Hello world express with https!"}

App (OUT) --> End
```

And viewing the log in the server, you have obtained:

```shell

result: {"message":"Hello world express with https!"}
```

__Client 2__

```shell
$ source ./init_client2.sh
$ npm run start

App (IN) --> Init

App (MID) --> endpoint: https://localhost:8443/hellotls
App (ERROR) --> error.message: request to https://localhost:8443/hellotls failed, reason: socket hang up
FetchError: request to https://localhost:8443/hellotls failed, reason: socket hang up
    at ClientRequest.<anonymous> (/home/diego/workdir/proyectos-GitHub/laboratories/nodejs_lab/23-Express-HTTPS-Not Self Signed-RequestCert -CRL/client/node_modules/node-fetch/lib/index.js:1455:11)
    at ClientRequest.emit (events.js:310:20)
    at TLSSocket.socketOnEnd (_http_client.js:460:9)
    at TLSSocket.emit (events.js:322:22)
    at endReadableNT (_stream_readable.js:1187:12)
    at processTicksAndRejections (internal/process/task_queues.js:84:21)

App (OUT) --> End
```

And viewing the log in the server, you have obtained:


## 10 .Executing all in docker

### 10.1 Run the server

Go to root folder and execute:

```shell
$ docker-compose up -d server-tls
```

### 10.2 Run the client

Go to root folder and execute:

```shell
$ docker-compoes up client-tls
```
